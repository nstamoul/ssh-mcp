services:
  ssh-mcp-server:
    # Use host network to access MacBook's VPN interfaces
    # network_mode: "host"
    # Connect to gateway network
    networks:
      - t2_proxy
    ports:
      - "3009:3009"
    # Volume mounts for SSH configuration
    # IMPORTANT: Mount your SSH config and keys as read-only
    volumes:
      # SSH configuration (read-only)
      - ${HOME}/.ssh/config:/home/mcp/.ssh/config:ro
      - ${HOME}/.ssh/known_hosts:/home/mcp/.ssh/known_hosts:ro
      # SSH keys (read-only)
      # Mount your SSH keys here - adjust paths as needed
      - ${HOME}/.ssh/id_ed25519:/home/mcp/.ssh/id_ed25519_mcp:ro
      - ${HOME}/.ssh/id_rsa:/home/mcp/.ssh/id_rsa:ro
      - ${HOME}/.ssh/id_rsa:/home/mcp/.ssh/id_rsa_openssh:ro
      - ${HOME}/.ssh/id_rsa:/home/mcp/.ssh/id_rsa_windows:ro
    labels:
      # Enable Traefik
      - traefik.enable=true
      # Router: match host and path prefix
      - traefik.http.routers.ssh-mcp.rule=Host(`mcp.nstam.eu`) && PathPrefix(`/ssh`)
      - traefik.http.routers.ssh-mcp.priority=20
      - traefik.http.routers.ssh-mcp.entrypoints=https
      - traefik.http.routers.ssh-mcp.tls=true
      # Middleware: strip /ssh prefix
      - traefik.http.middlewares.ssh-strip.stripprefix.prefixes=/ssh
      - traefik.http.middlewares.ssh-strip.stripprefix.forceSlash=false
      # Apply middleware chain: auth + strip prefix
      - traefik.http.routers.ssh-mcp.middlewares=chain-authelia@file,ssh-strip@docker
      # Service configuration
      - traefik.http.services.ssh-mcp.loadbalancer.server.port=3009
      # Well-known router to rewrite /.well-known requests into /ssh/.well-known before stripping
      - traefik.http.routers.ssh-mcp-wellknown.rule=Host(`mcp.nstam.eu`) && PathPrefix(`/.well-known`)
      - traefik.http.routers.ssh-mcp-wellknown.priority=30
      - traefik.http.routers.ssh-mcp-wellknown.entrypoints=https
      - traefik.http.routers.ssh-mcp-wellknown.tls=true
      - traefik.http.routers.ssh-mcp-wellknown.middlewares=chain-authelia@file,ssh-wellknown-rewrite@file,ssh-strip@docker
      - traefik.http.routers.ssh-mcp-wellknown.service=ssh-mcp
      # Secondary router with HTTP basic auth
      - traefik.http.routers.ssh2.rule=Host(`mcp.nstam.eu`) && PathPrefix(`/ssh2`)
      - traefik.http.routers.ssh2.entrypoints=https
      - traefik.http.routers.ssh2.tls=true
      - traefik.http.middlewares.ssh2-strip.stripprefix.prefixes=/ssh2
      - traefik.http.routers.ssh2.middlewares=chain-basic-auth@file,ssh2-strip@docker
      - traefik.http.routers.ssh2.service=ssh-mcp
      # Root router (no /ssh prefix) for legacy OAuth consumers
      - traefik.http.routers.ssh-mcp-root.rule=Host(`mcp.nstam.eu`)
      - traefik.http.routers.ssh-mcp-root.priority=10
      - traefik.http.routers.ssh-mcp-root.entrypoints=https
      - traefik.http.routers.ssh-mcp-root.tls=true
      - traefik.http.routers.ssh-mcp-root.middlewares=chain-authelia@file
      - traefik.http.routers.ssh-mcp-root.service=ssh-mcp

# External network created by MCP Gateway
networks:
  t2_proxy:
    external: true
    name: t2_proxy
